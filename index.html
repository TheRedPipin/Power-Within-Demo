<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Power Within Incremental — Mobile Demo</title>
<style>
  :root{
    --bg:#0b0c10;
    --panel:#121319;
    --panel-2:#171823;
    --accent:#9be564;
    --accent-2:#66d9ef;
    --warn:#ffaf45;
    --text:#e8eaf1;
    --muted:#9aa0b4;
    --good:#4ade80;
    --bad:#f87171;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
    -webkit-font-smoothing:antialiased;
    -webkit-tap-highlight-color: transparent;
  }

  .wrap{
    max-width: 480px;
    margin: 0 auto;
    min-height: 100dvh;
    display:flex;
    flex-direction:column;
    gap:12px;
    padding:12px;
  }

  .card{
    background:linear-gradient(180deg,var(--panel),var(--panel-2));
    border:1px solid #1e2130;
    border-radius:14px;
    padding:12px;
    box-shadow:0 6px 18px rgba(0,0,0,.25);
  }

  .header{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:8px 12px;
    align-items:center;
  }
  .title{
    font-weight:700;
    font-size:18px;
    letter-spacing:.2px;
  }
  .subtitle{
    font-size:12px;color:var(--muted)
  }

  .metrics{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .pill{
    background:#0f1220;
    border:1px solid #20253a;
    border-radius:999px;
    padding:6px 10px;
    font-size:12px;
  }

  /* Screen / Player */
  .screen{
    position:relative;
    height:280px;
    border-radius:12px;
    background:#06070d;
    border:1px solid #1a1e2b;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .scanlines::after{
    content:"";
    position:absolute; inset:0;
    pointer-events:none;
    background:
      repeating-linear-gradient( to bottom,
        rgba(255,255,255,.05) 0px,
        rgba(255,255,255,.05) 1px,
        transparent 2px,
        transparent 4px
      );
    mix-blend-mode: soft-light;
    opacity:.25;
  }
  .particles{
    position:absolute; inset:0; overflow:hidden; pointer-events:none;
  }
  .dot{
    position:absolute; width:2px; height:2px; border-radius:50%;
    background:rgba(255,255,255,.25);
    filter:blur(.2px);
    animation: drift linear infinite;
  }
  @keyframes drift{
    from{ transform: translateY(0) translateX(0)}
    to{ transform: translateY(-140px) translateX(40px)}
  }

  .player{
    width:84px; height:84px; border-radius:10px;
    background: radial-gradient( circle at 50% 50%, #b6ff7a 0%, #6bdc5c 40%, #2a7c36 60%, #0e1a11 100%);
    box-shadow:
      0 0 0 0 rgba(155,229,100,.25),
      0 0 30px 6px rgba(155,229,100,.25) inset;
    transform: scale(1);
    transition: box-shadow .15s;
  }
  .player.charging{
    box-shadow:
      0 0 24px 8px rgba(155,229,100,.28),
      0 0 36px 10px rgba(155,229,100,.18) inset;
  }
  .pulse{
    animation: pulse .3s ease-out;
  }
  @keyframes pulse{
    0%{ transform: scale(1)}
    40%{ transform: scale(1.25)}
    100%{ transform: scale(1)}
  }

  /* Bars and Buttons */
  .bar{
    width:100%;
    height:16px;
    background:#0e1120;
    border:1px solid #1f2440;
    border-radius:999px;
    overflow:hidden;
  }
  .bar > .fill{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,var(--accent),#8cf2a0);
    transition: width .12s linear;
  }
  .row{ display:flex; gap:10px; align-items:center }
  .stack{ display:flex; flex-direction:column; gap:8px }

  .btn{
    flex:1;
    font-size:16px;
    padding:14px 16px;
    background:#111628;
    color:var(--text);
    border:1px solid #243050;
    border-radius:12px;
    text-align:center;
    user-select:none;
  }
  .btn:active{ transform:translateY(1px)}
  .btn.primary{ background:linear-gradient(180deg,#18223a,#11192f); border-color:#31406a}
  .btn.accent{ background:linear-gradient(180deg,#16321c,#0f2514); border-color:#2d6a3b; color:#dfffe6}
  .btn.warn{ background:linear-gradient(180deg,#3a2a16,#2b1c0c); border-color:#6a4a2d; color:#ffe9c9}

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }

  .section-title{ font-size:14px; color:var(--muted); margin-bottom:6px }

  .skill{
    background:#0d1020;
    border:1px solid #20243a;
    border-radius:12px;
    padding:10px;
    display:flex; flex-direction:column; gap:6px;
  }
  .skill .name{ font-weight:700; font-size:14px }
  .skill .desc{ font-size:12px; color:var(--muted) }
  .skill .cost{ font-size:12px; color:#d8ffcc }
  .skill .row{ gap:6px }
  .skill .toggle{
    padding:6px 10px; border-radius:999px; font-size:12px;
    border:1px solid #2b334e; background:#141a2f; color:#e7ecff; text-align:center; flex:0;
  }
  .skill .buy{
    padding:6px 10px; border-radius:999px; font-size:12px;
    border:1px solid #2a5033; background:#122016; color:#d5ffe1; text-align:center; flex:0;
  }
  .skill.locked{ opacity:.55 }

  .ach{
    display:flex; justify-content:space-between; align-items:center;
    padding:10px; border-radius:10px; border:1px solid #232942; background:#0e1226; margin-bottom:6px;
    font-size:13px;
  }
  .ach .badge{
    font-size:11px; padding:4px 8px; border-radius:999px; background:#0f2413; border:1px solid #234a2d; color:#d7ffdc;
  }

  .footer-note{ color:var(--muted); font-size:12px; text-align:center; padding:6px 0 10px }
</style>
</head>
<body>
  <div class="wrap">

    <div class="card header">
      <div>
        <div class="title">Power Within Incremental</div>
        <div class="subtitle">Charge Energy. Expel for Power. Prestige for Mastery.</div>
      </div>
      <div class="metrics">
        <div class="pill">PL <span id="plText">0</span></div>
        <div class="pill">MP <span id="mpText">0</span></div>
        <div class="pill">Next Prestige <span id="prestigeTargetText">100</span></div>
      </div>
    </div>

    <div class="card screen scanlines" id="screen">
      <div class="particles" id="particles"></div>
      <div class="player" id="player"></div>
    </div>

    <div class="card">
      <div class="section-title">Energy</div>
      <div class="bar" aria-label="Energy">
        <div class="fill" id="energyFill"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="pill">Energy <span id="energyText">0</span>/<span id="energyCapText">100</span></div>
        <div class="pill">Charge Rate <span id="rateText">1.00</span></div>
      </div>
      <div class="grid" style="margin-top:10px">
        <button id="btnCharge" class="btn accent" aria-pressed="false">Hold Charge</button>
        <button id="btnExpel" class="btn primary">Expel</button>
      </div>
      <button id="btnPrestige" class="btn warn" style="margin-top:10px; display:none">Prestige</button>
    </div>

    <div class="card">
      <div class="section-title">Passives and Skills</div>
      <div class="row" style="margin-bottom:8px">
        <div class="pill">Passive Slots <span id="passiveSlotsText">1</span></div>
      </div>
      <div class="grid" id="skillsGrid">
        <!-- Skills injected by JS -->
      </div>
    </div>

    <div class="card">
      <div class="section-title">Achievements</div>
      <div id="achList"></div>
    </div>

    <div class="footer-note">Demo build. Saves locally every few seconds.</div>
  </div>

<script>
/* ---------- State ---------- */
const state = {
  version: 1,
  powerLevel: 0,
  displayPL: 0,
  mastery: 0,
  energy: 0,
  baseEnergyCap: 100,
  chargeRate: 1,
  chargeTime: 1,
  isCharging: false,
  attackPowerFrac: 0.25, // spend this fraction of cap if available
  attackMulti: 1,
  prestigeTarget: 100,
  passiveSlots: 1,
  activePassives: [], // ids
  skills: {}, // id -> {bought:bool, active:bool}
  achievements: {}, // id -> bool
};

/* ---------- Utilities ---------- */
const clamp = (v,min,max)=> v<min?min: v>max?max: v;
const fmt = (n)=> {
  if (n < 1000) return Math.floor(n).toString();
  const units = ["K","M","B","T","Qa","Qi","Sx","Sp","Oc","No","Dc"];
  let u = -1;
  let x = n;
  while (x >= 1000 && u < units.length-1){ x/=1000; u++; }
  return x.toFixed(x<10?2:x<100?1:0) + units[u];
}

/* ---------- Derived Stats from Passives ---------- */
function effectiveMultipliers(){
  let chargeMul = 1;
  let plMul = 1;
  let capMul = 1;
  // active passives
  if (isActive("burning")) { plMul *= 1.15; chargeMul *= 0.9; }
  if (isActive("still"))   { capMul *= 1.25; plMul *= 0.9; }
  if (isActive("spark"))   { chargeMul *= 1.2; }
  return {chargeMul, plMul, capMul};
}
function isActive(id){ return !!(state.skills[id]?.bought && state.skills[id]?.active); }

/* ---------- Skills Definition ---------- */
const skillDefs = [
  {
    id:"slot_plus",
    name:"Passive Slot +1",
    desc:"Increase passive slots by 1.",
    cost:3,
    type:"utility",
    onBuy:()=>{ state.passiveSlots += 1; },
    toggleable:false
  },
  {
    id:"burning",
    name:"Burning Heart",
    desc:"+15% PL on Expel, −10% Charge Rate while active.",
    cost:2,
    type:"passive",
    toggleable:true
  },
  {
    id:"still",
    name:"Still Core",
    desc:"+25% Energy Cap, −10% PL while active.",
    cost:2,
    type:"passive",
    toggleable:true
  },
  {
    id:"spark",
    name:"Spark Pulse",
    desc:"+20% Charge Rate while active.",
    cost:2,
    type:"passive",
    toggleable:true
  }
];

/* ---------- Achievements ---------- */
const achDefs = [
  {id:"first_charge", name:"First Charge", test:()=>state.energy>0, reward:1},
  {id:"first_expel", name:"First Expel", test:()=>state.powerLevel>0, reward:1},
  {id:"pl_100", name:"Reach 100 PL", test:()=>state.powerLevel>=100, reward:1},
  {id:"pl_1k", name:"Reach 1,000 PL", test:()=>state.powerLevel>=1000, reward:2},
  {id:"full_energy", name:"Full Battery", test:()=>state.energy>=effectiveCap(), reward:1},
  {id:"first_prestige", name:"First Prestige", test:()=> state.mastery>0, reward:0},
];
function grantAchievement(id){
  if (state.achievements[id]) return;
  const ach = achDefs.find(a=>a.id===id);
  if (!ach) return;
  state.achievements[id] = true;
  if (ach.reward>0) state.mastery += ach.reward;
  renderAchievements();
  persist();
}

/* ---------- DOM ---------- */
const el = {
  plText: document.getElementById("plText"),
  mpText: document.getElementById("mpText"),
  prestigeTargetText: document.getElementById("prestigeTargetText"),
  energyFill: document.getElementById("energyFill"),
  energyText: document.getElementById("energyText"),
  energyCapText: document.getElementById("energyCapText"),
  rateText: document.getElementById("rateText"),
  btnCharge: document.getElementById("btnCharge"),
  btnExpel: document.getElementById("btnExpel"),
  btnPrestige: document.getElementById("btnPrestige"),
  player: document.getElementById("player"),
  skillsGrid: document.getElementById("skillsGrid"),
  passiveSlotsText: document.getElementById("passiveSlotsText"),
  achList: document.getElementById("achList"),
  particles: document.getElementById("particles"),
  screen: document.getElementById("screen"),
};

/* ---------- Particles in Screen ---------- */
(function initParticles(){
  const count = 48;
  for(let i=0;i<count;i++){
    const d = document.createElement("div");
    d.className = "dot";
    const x = Math.random()*100, y = Math.random()*100;
    d.style.left = x+"%";
    d.style.top = y+"%";
    d.style.animationDuration = (8+Math.random()*10)+"s";
    d.style.opacity = String(0.2 + Math.random()*0.35);
    el.particles.appendChild(d);
  }
})();

/* ---------- Skill UI ---------- */
function renderSkills(){
  el.skillsGrid.innerHTML = "";
  skillDefs.forEach(def=>{
    if (!state.skills[def.id]) state.skills[def.id] = {bought:false, active:false};
    const s = state.skills[def.id];
    const card = document.createElement("div");
    card.className = "skill"+(s.bought?"":" locked");
    card.innerHTML = `
      <div class="name">${def.name}</div>
      <div class="desc">${def.desc}</div>
      <div class="row">
        <div class="cost">${s.bought? "Owned" : `Cost ${def.cost} MP`}</div>
        ${def.toggleable && s.bought ? `<button class="toggle">${s.active?"On":"Off"}</button>` : ""}
        ${!s.bought ? `<button class="buy">Buy</button>` : ""}
      </div>
    `;
    const buy = card.querySelector(".buy");
    const toggle = card.querySelector(".toggle");
    if (buy){
      buy.addEventListener("click", ()=>{
        if (state.mastery >= def.cost){
          state.mastery -= def.cost;
          s.bought = true;
          if (def.onBuy) def.onBuy();
          renderAll();
          persist();
        }
      });
    }
    if (toggle){
      toggle.addEventListener("click", ()=>{
        // enforce passive slots for passives
        if (def.type==="passive"){
          const activeCount = skillDefs.filter(d=>d.type==="passive" && isActive(d.id)).length;
          if (!s.active && activeCount >= state.passiveSlots) return; // no free slot
        }
        s.active = !s.active;
        renderAll();
        persist();
      });
    }
    el.skillsGrid.appendChild(card);
  });
}

/* ---------- Achievements UI ---------- */
function renderAchievements(){
  el.achList.innerHTML = "";
  achDefs.forEach(a=>{
    const got = !!state.achievements[a.id];
    const row = document.createElement("div");
    row.className = "ach";
    row.innerHTML = `
      <div>${a.name}</div>
      <div class="badge">${got? "Claimed" : `+${a.reward} MP`}</div>
    `;
    el.achList.appendChild(row);
  });
}

/* ---------- Derived Cap ---------- */
function effectiveCap(){
  const {capMul} = effectiveMultipliers();
  return Math.floor(state.baseEnergyCap * capMul);
}

/* ---------- Charge, Expel, Prestige ---------- */
function startCharge(){
  state.isCharging = true;
  el.btnCharge.setAttribute("aria-pressed","true");
  el.player.classList.add("charging");
}
function stopCharge(){
  state.isCharging = false;
  el.btnCharge.setAttribute("aria-pressed","false");
  el.player.classList.remove("charging");
  state.chargeTime = 1;
}
function expel(){
  if (state.energy <= 0) return;

  const cap = effectiveCap();
  const spendTarget = cap * state.attackPowerFrac;
  let spent;
  if (state.energy > spendTarget){
    state.energy -= spendTarget;
    spent = spendTarget;
  } else {
    spent = state.energy;
    state.energy = 0;
  }
  const {plMul} = effectiveMultipliers();
  const gain = Math.floor(spent * state.attackMulti * plMul);
  state.powerLevel += gain;

  // pulse animation on player
  el.player.classList.remove("pulse");
  // force reflow to restart animation
  void el.player.offsetWidth;
  el.player.classList.add("pulse");

  grantAchievement("first_expel");
  renderCore();
  persist();
}
function canPrestige(){ return state.powerLevel >= state.prestigeTarget; }
function prestige(){
  if (!canPrestige()) return;
  const mpGain = Math.floor(state.powerLevel / state.prestigeTarget); // 1 MP at threshold, +1 per extra multiple
  state.mastery += mpGain;
  state.powerLevel = 0;
  state.displayPL = 0;
  state.energy = 0;
  state.chargeTime = 1;
  state.prestigeTarget = Math.floor(state.prestigeTarget * 2); // escalate
  grantAchievement("first_prestige");
  renderAll();
  persist();
}

/* ---------- Input (touch friendly) ---------- */
function bindPressHold(elm, onDown, onUp){
  let down = false;
  const d = (e)=>{ e.preventDefault(); if (down) return; down = true; onDown(); };
  const u = (e)=>{ e.preventDefault(); if (!down) return; down = false; onUp(); };
  elm.addEventListener("mousedown", d);
  elm.addEventListener("touchstart", d, {passive:false});
  window.addEventListener("mouseup", u);
  window.addEventListener("touchend", u);
  window.addEventListener("touchcancel", u);
}
bindPressHold(el.btnCharge, startCharge, stopCharge);
const onExpel = (e)=>{
  e.preventDefault();
  if (state.isCharging) stopCharge();
  expel();
};
el.btnExpel.addEventListener("touchstart", onExpel, {passive:false});
el.btnExpel.addEventListener("click", onExpel);
el.btnPrestige.addEventListener("click", prestige);

/* ---------- Save / Load ---------- */
const SAVE_KEY = "pwi_demo_v1";
function persist(){
  try{
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  }catch(e){}
}
function load(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return;
    const dat = JSON.parse(raw);
    Object.assign(state, dat);
    // ensure new fields exist
    state.version = 1;
  }catch(e){}
}

/* ---------- Render ---------- */
function renderCore(){
  el.plText.textContent = fmt(state.displayPL);
  el.mpText.textContent = fmt(state.mastery);
  el.prestigeTargetText.textContent = fmt(state.prestigeTarget);

  const cap = effectiveCap();
  el.energyCapText.textContent = fmt(cap);
  el.energyText.textContent = fmt(state.energy);
  const pct = clamp((state.energy / cap) * 100, 0, 100);
  el.energyFill.style.width = pct + "%";

  const {chargeMul} = effectiveMultipliers();
  el.rateText.textContent = (state.chargeRate * chargeMul).toFixed(2);

  el.btnPrestige.style.display = canPrestige()? "" : "none";
  el.passiveSlotsText.textContent = state.passiveSlots.toString();
}
function renderAll(){
  renderCore();
  renderSkills();
  renderAchievements();
}

/* ---------- Loop ---------- */
let last = performance.now();
function loop(now){
  const dt = Math.min(0.05, (now - last)/1000); // clamp dt
  last = now;

  // smooth PL display
  const targetPL = state.powerLevel;
  if (state.displayPL !== targetPL){
    const diff = targetPL - state.displayPL;
    const step = Math.sign(diff) * Math.max(1, Math.abs(diff) * 0.12);
    state.displayPL += step;
    if (Math.sign(targetPL - state.displayPL) !== Math.sign(diff)){
      state.displayPL = targetPL;
    }
  }

  // charging
  if (state.isCharging){
    const {chargeMul} = effectiveMultipliers();
    // Increasing return while holding (like your Godot prototype)
    const inc = state.chargeRate * state.chargeTime * chargeMul;
    state.energy += inc * dt * 20; // scale factor for feel on mobile
    state.chargeTime += dt;
    grantAchievement("first_charge");
    if (state.energy >= effectiveCap()){
      state.energy = effectiveCap();
      grantAchievement("full_energy");
    }
  }

  // achievements passive checks
  if (state.powerLevel>=100) grantAchievement("pl_100");
  if (state.powerLevel>=1000) grantAchievement("pl_1k");

  renderCore();
  requestAnimationFrame(loop);
}

/* ---------- Init ---------- */
load();
renderAll();
requestAnimationFrame(loop);
setInterval(persist, 5000);

/* ---------- Accessibility: Swipe-to-expel (optional) ---------- */
let touchStartY = null;
el.screen.addEventListener("touchstart", (e)=>{ if (e.touches[0]) touchStartY = e.touches[0].clientY; }, {passive:true});
el.screen.addEventListener("touchend", (e)=>{
  if (touchStartY==null) return;
  const y = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientY : touchStartY;
  if (touchStartY - y > 40){ expel(); } // swipe up to expel
  touchStartY = null;
});
</script>
</body>
</html>

